<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Liste des produits</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" th:href="@{/}">Spring CRUD</a> <button class="navbar-toggler" type="button"
                data-bs-toggle="collapse" data-bs-target="#navMenu" aria-controls="navMenu" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navMenu">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" th:href="@{/}">Home</a></li>
                    <li class="nav-item"><a class="nav-link active" th:href="@{/produits}">Produits</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="h3">Produits</h1>
            <button type="button" class="btn btn-success" onclick="openNewModal()">Nouveau produit</button>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Désignation</th>
                        <th>Quantité</th>
                        <th>Prix</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="p : ${produits}">
                        <td th:text="${p.id}">1</td>
                        <td th:text="${p.designation}">Designation</td>
                        <td th:text="${p.quantite}">0</td>
                        <td th:text="${p.prix}">0.0</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-primary me-1"
                                th:onclick="|openViewModal(${p.id})|">Voir</button>
                            <button type="button" class="btn btn-sm btn-warning text-white me-1"
                                th:onclick="|openEditModal(${p.id})|">Éditer</button>
                            <button type="button" class="btn btn-sm btn-danger"
                                th:onclick="|openDeleteModal(${p.id})|">Supprimer</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

    </main>

    <!-- Product modal (create / edit) -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="productForm" th:action="@{/produits/save}" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title" id="productModalLabel">Produit</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="id" id="product-id" value="0" />

                        <div class="mb-3">
                            <label class="form-label">Désignation</label>
                            <input class="form-control" name="designation" id="product-designation" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Quantité</label>
                            <input class="form-control" type="number" name="quantite" id="product-quantite" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Prix</label>
                            <input class="form-control" type="number" step="0.1" name="prix" id="product-prix"
                                required />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Helper to show modal for new product
        function openNewModal() {
            document.getElementById('product-id').value = 0;
            document.getElementById('product-designation').value = '';
            document.getElementById('product-quantite').value = '';
            document.getElementById('product-prix').value = '';
            document.getElementById('productModalLabel').textContent = 'Créer un produit';
            const modalEl = document.getElementById('productModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }

        // Helper to open modal and populate fields for edit
        function openEditModal(id) {
            fetch('/produits/api/' + id)
                .then(response => {
                    if (!response.ok) throw new Error('Produit not found');
                    return response.json();
                })
                .then(p => {
                    document.getElementById('product-id').value = p.id;
                    document.getElementById('product-designation').value = p.designation || '';
                    document.getElementById('product-quantite').value = p.quantite || '';
                    document.getElementById('product-prix').value = p.prix || '';
                    document.getElementById('productModalLabel').textContent = 'Éditer le produit ' + p.id;
                    const modalEl = document.getElementById('productModal');
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                })
                .catch(err => {
                    console.error(err);
                    alert('Impossible de charger le produit.');
                });
        }
    </script>


    <!-- View Product Modal -->
    <div class="modal fade" id="viewModal" tabindex="-1" aria-labelledby="viewModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewModalLabel">Détails du produit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered mb-0">
                        <tbody>
                            <tr>
                                <th>ID</th>
                                <td id="view-id"></td>
                            </tr>
                            <tr>
                                <th>Désignation</th>
                                <td id="view-designation"></td>
                            </tr>
                            <tr>
                                <th>Quantité</th>
                                <td id="view-quantite"></td>
                            </tr>
                            <tr>
                                <th>Prix</th>
                                <td id="view-prix"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Helper to open modal and display product details
        function openViewModal(id) {
            fetch('/produits/api/' + id)
                .then(response => {
                    if (!response.ok) throw new Error('Produit not found');
                    return response.json();
                })
                .then(p => {
                    document.getElementById('view-id').textContent = p.id;
                    document.getElementById('view-designation').textContent = p.designation || '';
                    document.getElementById('view-quantite').textContent = p.quantite || '';
                    document.getElementById('view-prix').textContent = p.prix || '';
                    const modalEl = document.getElementById('viewModal');
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                })
                .catch(err => {
                    console.error(err);
                    alert('Impossible de charger le produit.');
                });
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>

</html>
<!-- Delete confirmation modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirmer la suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Voulez-vous vraiment supprimer ce produit ?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Supprimer</button>
            </div>
        </div>
    </div>
</div>

<script>
    let _deleteId = null;
    function openDeleteModal(id) {
        _deleteId = id;
        const delModalEl = document.getElementById('deleteModal');
        const delModal = new bootstrap.Modal(delModalEl);
        delModal.show();
    }

    document.addEventListener('DOMContentLoaded', function () {
        const btn = document.getElementById('confirmDeleteBtn');
        if (btn) {
            btn.addEventListener('click', function () {
                if (_deleteId !== null) {
                    window.location.href = '/produits/delete/' + _deleteId;
                }
            });
        }
    });
</script>